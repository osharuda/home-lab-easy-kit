<p align="center"><img src="../doc/images/hlek.svg"></p>

# <p align="center">Introduction</p>


## Table of contents
1. [Key components](#Key-components)
2. [Hardware requirements](#Hardware-requirements)
3. [Software requirements](#Software-requirements)
4. [Usage instructions](#Usage-instructions)
5. [Available peripherals](#Available-peripherals)

## Key components

Project consist of three parts: Customizer, Firmware and Software.

`JSON configuration file` is written by user to describe peripherals on a single MCU. This file describes user requirements to customizer and allows to generate configuration library and firmware sources for this MCU. If several MCUs are required, then the same number of JSON files should be written, one file per MCU.

`Customizer` generates C and C++ sources required for firmware and software parts. Also customizer is capable to detect some issues in JSON configuration and to make a corresponding warning.

`Firmware` part is CMSIS based firmware project written on C. It is generated from user provided JSON files. Once headers are generated by customizer it may be compiled and flashed into MCU. User is not required to change firmware sources, however it is not forbidden. If you need several MCU to be connected to your microcomputer, you will have to write the same number of JSON files (with different I2C addresses), generate several firmware binaries, and flash all of your MCUs one by one.

`Software` part consists of two libraries provided to work with project:
- libhlek - is a library (doesn't require configuration) which implements all work with supported devices from microcomputer side. User program should link with this library in order to use project.
- configuration library (libconfig, optional) - is a generated library (library name is always different, based on source JSON file name). This library provides information about STM32F103 MCU to be connected and used. It has description of all devices being associated with the given MCU. If you need to connect several MCUs to your microcomputer you will have to generate several such configuration libraries. All libraries are separated by unique C++ namespaces to avoid naming collisions.

`Documentation` Documentation is split onto three parts.
- This document serves as introduction. Also it explains basic things like software and hardware requirements, JSON configuration file, etc.
- Software documentation is provided in doxygen form. It should be generated in order to get more information on classes, interfaces, etc. It is required if you plan to use this project.
- Firmware documentation is also provided in doxygen form. It is optional and incomplete. Someone, curious, may use it to understand how firmware works.

## Hardware requirements
- Computer or microcomputer with Linux and possibility to connect and work with I2C bus. Software implementations of I2C bus also should work. Note, I2C will not be used in clock stretching mode. It means all Raspberry Pi versions may be used (I2C stretching bug in BCM2835 processor shouldn't be a barrier)
- STM32F103C8T6 micro controller. It may be one of "Blue pill" boards or self made PCB with this micro controller. Some part of the project may be used without MCU at all.
- STM32 ST-LINK v2 programmer or any other capable to work with STM32F103C8T6. Required only if you plan use MCU.
- Power supply capable to provide as much power as your project require. Prefer power supplies with ground line. Avoid using two or more power supplies in your project, this may cause serious issues.

## Software requirements
Below is a description of software dependencies required to use Home Lab Easy Kit project.

The following packages are used by Home Lab Easy Kit project:
- `Raspberry Pi OS Buster` : This is a new version of Raspberry Pi OS to be installed on Raspberry Pi microcomputer. Other Linux distributions may also be used and configured in this way, however some packages may be missing or have different names. Note, not all of the packages may be available for previous versions (before Buster) of Raspberry Pi OS. This project is not limited by Raspberry Pi, however it is difficult to write instructions for all possible microcomputers and operational systems. So, Raspberry Pi and `Raspberry Pi OS Buster` is basic configuration for instructions. Other configuration may require different configuration process.
- `CMake`: With version >= 3.10. Install `cmake` package.You may get more CMake project information [here](https://cmake.org/).
- `ICU4C`: International Components for Unicode (for C/C++). It is official library from the Unicode Consortium. It is included in many Linux distributions, however in our case development files are required. Install `libicu-dev` package. You may get more information [here](http://site.icu-project.org/home).
- `GNU Arm Embedded Toolchain`: It is a collection of packages required for bare-metal software development using 32-bit ARM processors. It also includes Cortex-M, used in STM32F103x. Install these packages: `binutils-arm-none-eabi`, `gcc-arm-none-eabi`, `gdb-multiarch`. Note, `tools` variable in firmware/toolchain.cmake should be modified to specify path to toolchain in order to configure project for CMake. More information about GNU Arm Embedded Toolchain project is [here](https://developer.arm.com/tools-and-software/open-source-software/developer-tools/gnu-toolchain/gnu-rm).
- `STM32F10x Standard Peripherals Library`: This is a library from [STMicroelectronics](https://www.st.com) which is required to build firmware. It can be downloaded from ST web site [directly](http://www.st.com/st-web-ui/static/active/en/st_prod_software_internet/resource/technical/software/firmware/stsw-stm32054.zip). Unpack library and modify STDPERIF_PATH variable in firmware/toolchain.cmake. It is possible to get “registers may not be the same” compilation errors with this library. If the error appears use [patch](https://gist.github.com/timbrom/1942280) to fix it.
- `OpenOCD`: Open On-Chip Debugger project required to debug firmware. Optionally it may be used to flash firmware, or to debug it from your favorite IDE. Install `openocd` package. More information on OpenOCD project is [here](http://openocd.org/).
- `ST-LINK/V2 tools`: This software is required to flash and debug firmware. Install `stlink-tools` package. More information is [here](https://github.com/stlink-org/stlink)
- `i2c-tools`: are very useful during work with i2c bus. Install `i2c-tools` package.
- `doxygen`: Doxygen is required to generate documentation for firmware and software parts of the project. Install `doxygen` package. More information on Doxygen may be found [here](https://www.doxygen.nl/index.html).
- `ncurses` : This library is used for minimal terminal interface used by Home Lab Easy Kit monitor. Install `libncurses-dev` package.
- `python3`: Required to run Customizer, which is written using Python3. Python3 should be a part of the operational system.

The following command might be used to install everything at once:

```
apt update && apt install vim git mc cmake libicu-dev binutils-arm-none-eabi gcc-arm-none-eabi gdb-multiarch openocd stlink-tools i2c-tools doxygen libncurses-dev
```

I use command above to initialize my fresh Raspberry Pi installation. Therefore there might be some unrelated packages.

## Usage instructions

List below describes sequential actions required to start:
1. Install software dependencies.
2. Prepare JSON configuration file(s), if needed.
3. Run customizer with JSON configuration file passed as parameter, if you plan to use MCU.
4. Build firmware and flash MCU, if needed.
5. Build software and link generated library to your project.
6. Make all electrical connections for your project.

## Available peripherals
Please refer [supported devices](../doc/DEVICES.md) section in order to get list of currently supported virtual devices and features.
